<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head') %>
  <title>Add Expense - Smart Expense Splitter</title>
</head>
<body class="d-flex flex-column min-vh-100">

<%
  // defensive defaults to avoid runtime errors when route doesn't pass values
  groups = (typeof groups !== 'undefined') ? groups : [];
  user = (typeof user !== 'undefined') ? user : null;
  message = (typeof message !== 'undefined') ? message : null;
%>

<%- include('./partials/navbar', { page: 'expenses', userId: userId }) %>

<!-- attach groups JSON to a data attribute to avoid inline EJS in JS -->
<div id="app" class="container py-5 flex-grow-1" data-groups='<%- JSON.stringify(groups || []) %>'>
  <div class="row justify-content-center">
    <div class="col-md-8">
      <h2 class="fw-bold text-center text-pink mb-4">Add a New Expense ðŸ’¸</h2>

      <% if (message) { %>
        <div class="alert alert-danger"><%= message %></div>
      <% } %>

      <div class="card p-4 shadow-sm">
        <form action="/expenses" method="POST">
          <div class="mb-3">
            <label for="group" class="form-label fw-bold">For Which Group?</label>
            <% if (groups && groups.length > 0) { %>
              <select id="group" name="group" class="form-select" required>
                <option value="" disabled selected>Select a group...</option>
                <% groups.forEach(g => { %>
                  <option value="<%= g._id %>"><%= g.name %></option>
                <% }) %>
              </select>
            <% } else { %>
              <div class="alert alert-warning small m-0">
                You must <a href="/groups/new" class="alert-link">create a group</a> before adding an expense.
              </div>
            <% } %>
          </div>

          <div class="mb-3">
            <label for="amount" class="form-label fw-bold">Amount (â‚¹)</label>
            <input id="amount" name="amount" type="number" step="0.01" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="date" class="form-label fw-bold">Date</label>
            <input id="date" name="date" type="date" class="form-control" value="<%= new Date().toISOString().split('T')[0] %>" required>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label fw-bold">Description</label>
            <textarea id="description" name="description" class="form-control" rows="3"></textarea>
          </div>

          <button type="submit" class="btn btn-gradient w-100" <%= (groups && groups.length > 0) ? '' : 'disabled' %>>Add Expense</button>
          <a href="/expenses" class="btn btn-link w-100 mt-2 text-pink text-decoration-none">Cancel</a>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include('./partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // parse groups from the data attribute (avoids EJS tokens inside JS expressions)
  (function(){
    const appEl = document.getElementById('app');
    const __groups = appEl ? JSON.parse(appEl.dataset.groups || '[]') : [];
    console.log('DEBUG groups:', __groups);
    console.log('DEBUG groupsCount:', __groups.length);
  })();
</script>
</body>
</html>
