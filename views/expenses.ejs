<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head') %>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <title>Smart Expense Splitter</title>
</head>
<body class="d-flex flex-column min-vh-100">

  <nav class="navbar navbar-expand-lg py-3">
  <div class="container">
    <h4 class="fw-bold">Smart Expense Splitter</h4>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-center">
        <% if (!user) { %>
          <li class="nav-item"><a class="nav-link" href="/register">Sign Up</a></li>
          <li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
        <% } else { %>
          <li class="nav-item"><a class="nav-links active" href="/home">Home</a></li>
          <li class="nav-item"><a class="nav-links" href="/groups">Groups</a></li>
          <li class="nav-item"><a class="nav-links" href="/expenses">Expenses</a></li>
          <li class="nav-item"><a class="nav-links" href="/about">About</a></li>

          <!-- Profile Dropdown -->
          <li class="nav-item dropdown ms-3">
            <div class="dropdown">
              <div class="profile-trigger" onclick="toggleDropdown()">
                <img
                  src="<%= user.profilePic
                    ? '/uploads/' + user.profilePic
                    : 'https://i.pinimg.com/1200x/8b/84/17/8b841799752db5b6e1aa1aa56fe737db.jpg' %>"
                  alt="Profile"
                  class="profile-avatar"
                />
              </div>

              <div id="profileDropdown" class="dropdown-content shadow-lg">
                <a href="/profile"><i class="bi bi-person-circle"></i> Profile</a>
                <a href="/setting"><i class="bi bi-gear"></i> Settings</a>
                <form id="logoutForm" action="/logout" method="POST" style="display:inline;">
                  <button type="button" class="dropdown-logout" data-bs-toggle="modal" data-bs-target="#logoutModal">
                    <i class="bi bi-box-arrow-right"></i> Logout
                  </button>
                </form>
              </div>
            </div>
          </li>
        <% } %>
      </ul>
    </div>
  </div>
</nav>

  <div class="container my-5">
    <div class="row mb-4 align-items-center">
      <div class="col-md-9">
        <h2>My Expenses</h2>
        <p class="text-muted">A list of all expenses you're involved in.</p>
      </div>
      <div class="col-md-3 text-md-end">

        <button id="test-pay-btn" class="btn btn-success me-2">
          Test Pay â‚¹10
        </button>

        <a href="/expenses/new" class="btn btn-gradient">
          + Add New Expense
        </a>
      </div>
    </div>

    <div class="card shadow-sm">
      <ul class="list-group list-group-flush">
        <% if (expenses && expenses.length > 0) { %>
          <% expenses.forEach(expense => {
     const meKey = (typeof userId !== 'undefined' && userId) ? String(userId) : null;
     const participantsArr = (expense.participants && expense.participants.length)
       ? expense.participants.map(p => String(p))
       : ((expense.group && expense.group.members) ? expense.group.members.map(m => String(m._id)) : []);

     // skip rendering if current user is neither participant nor payer
     const isPayer = expense.paidBy && (String(expense.paidBy._id || expense.paidBy) === meKey);
     if (!participantsArr.includes(meKey) && !isPayer) { return; }
%>
  <li class="list-group-item d-flex justify-content-between align-items-start">
    <div>
      <h6 class="mb-1"><%= expense.description %></h6>
      <small class="text-muted">In group: <strong><%= expense.group && expense.group.name ? expense.group.name : 'â€”' %></strong></small>
      <div class="small text-muted">Paid by <strong><%= payeeName %></strong> on <%= new Date(expense.date).toLocaleDateString() %></div>

      <div class="mt-2">
        <small class="text-muted">Split:</small>
        <ul class="list-unstyled small mb-0">
          <%
            // iterate only participants for this expense
            participantsArr.forEach(pid => {
              const pidStr = String(pid);
              const member = (expense.group && expense.group.members) ? expense.group.members.find(m => String(m._id) === pidStr) : null;
              const displayName = member ? (member.username || member.name || member.email || pidStr) : pidStr;
              const splitAmt = (expense.splits && Object.prototype.hasOwnProperty.call(expense.splits, pidStr))
                ? Number(expense.splits[pidStr]).toFixed(2)
                : (Number(expense.amount) / (participantsArr.length || 1)).toFixed(2);
              const paidFlag = expense.paidSplits && expense.paidSplits[pidStr];
          %>
            <li>
              <strong><%= displayName %></strong>: â‚¹<%= splitAmt %>
              <% if (String(pidStr) === String(meKey)) { %>
                <% if (paidFlag || (expense.paidBy && (String(expense.paidBy._id || expense.paidBy) === String(meKey)))) { %>
                  <span class="badge bg-success ms-2">Paid</span>
                <% } else { %>
                  <span class="badge bg-warning text-dark ms-2">You owe</span>
                <% } %>
              <% } else if (paidFlag) { %>
                <span class="badge bg-success ms-2">Paid</span>
              <% } %>
            </li>
          <% }) %>
        </ul>
      </div>
    </div>

    <div class="text-end">
      <div class="fw-bold text-pink mb-2">â‚¹<%= Number(splitAmount).toFixed(2) %></div>

      <% /* Show Pay button only if current user is one of participants, owes and hasn't paid, and is not the payer */ %>
      <% if (meKey && participantsArr.includes(String(meKey)) && !mePaid && !(expense.paidBy && (String(expense.paidBy._id || expense.paidBy) === String(meKey)))) { %>
        <button
          class="btn btn-sm btn-primary pay-btn"
          data-expense-id="<%= expense._id %>"
          data-amount="<%= splitAmount.toFixed(2) %>"
          data-payee-name="<%= payeeName %>">
          Pay â‚¹<%= splitAmount.toFixed(2) %> to <%= payeeName %>
        </button>
      <% } else { %>
        <% if (meKey && mePaid) { %>
          <div class="text-success small">You paid</div>
        <% } %>
      <% } %>
    </div>
  </li>
<% }) %>
        <% } else { %>
          <li class="list-group-item text-center text-muted p-4">
            You have no expenses yet.
          </li>
        <% } %>
      </ul>
    </div>
  </div>
  <!-- ðŸŒ¸ Aesthetic Pink Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content logout-modal text-center shadow-lg">
      <div class="modal-header border-0 justify-content-center">
        <h5 class="modal-title fw-bold fs-4 logout-title" id="logoutModalLabel">
          Are you sure you want to logout?
        </h5>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-4">Youâ€™ll be signed out from Smart Expense Splitter ðŸ’—</p>
        <div class="d-flex justify-content-center gap-3">
          <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn confirm-logout-btn" onclick="logoutUser()">Logout</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <%- include('./partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // razorpayKeyId already passed from server
    const razorpayKeyId = '<%= razorpayKeyId %>';

    document.addEventListener('click', async function (e) {
      const btn = e.target.closest('.pay-btn');
      if (!btn) return;
      e.preventDefault();

      const expenseId = btn.dataset.expenseId;
      const amount = Number(btn.dataset.amount);
      if (!expenseId || !amount) return alert('Invalid payment amount.');

      // create order and open razorpay (server routes from earlier)
      const resp = await fetch('/create-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ expenseId, amount })
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ message: 'Server error' }));
        return alert(err.message || 'Could not create order.');
      }
      const order = await resp.json();

      const options = {
        key: razorpayKeyId,
        amount: order.amount,
        currency: order.currency,
        name: "Smart Expense Splitter",
        description: `Pay split for expense ${expenseId}`,
        order_id: order.id,
        handler: async function (paymentResponse) {
          const verifyResp = await fetch('/verify-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              razorpay_order_id: paymentResponse.razorpay_order_id,
              razorpay_payment_id: paymentResponse.razorpay_payment_id,
              razorpay_signature: paymentResponse.razorpay_signature,
              expenseId
            })
          });
          const data = await verifyResp.json();
          if (data.status === 'success') {
            alert('Payment successful.');
            location.reload();
          } else {
            alert('Payment verification failed.');
          }
        },
        prefill: {},
        theme: { color: "#F0B0BD" }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    });

    function logoutUser() {
      document.getElementById("logoutForm")?.submit();
    }
  </script>
</body>
</html>