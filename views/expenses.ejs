<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head') %>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <title>Smart Expense Splitter</title>
  <style>
    /* ðŸŒ¸ General Page Style */
body {
  background-color: #fff8fa;
  font-family: "Poppins", sans-serif;
  color: #333;
}

/* ðŸŒ· Headings */
h2 {
  font-weight: 600;
  font-size: 2.1rem;
  color: rgb(230, 120, 142);
  letter-spacing: 2px;
  font-family: 'Pacifico', cursive, sans-serif;
}

/* âœ¨ Card Styling */
.expense-card {
  border: none;
  border-radius: 18px;
  background: #ffffff;
  box-shadow: 0 3px 12px rgba(233, 30, 99, 0.1);
  transition: all 0.25s ease;
}

.expense-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 5px 16px rgba(233, 30, 99, 0.2);
}

/* ðŸŒ¸ Card Title & Text */
.expense-card .card-title {
  font-weight: 500;
  color: #444;
}

.expense-card small,
.expense-card .text-muted {
  font-size: 0.88rem;
  color: #777 !important;
}

/* ðŸ’° Amounts */
.text-pink {
  color: #e91e63 !important;
}

.btn-gradient {
  background: linear-gradient(135deg, #ff8ba7, #e91e63);
  border: none;
  color: #fff !important;
  font-weight: 500;
  border-radius: 25px;
  padding: 10px 22px;
  transition: all 0.3s ease;
}

.btn-gradient:hover {
  background: linear-gradient(135deg, #ff5f85, #d81b60);
  transform: translateY(-2px);
}
/* ðŸŒ· Filter Dropdown */
#filterSelect {
  appearance: none; /* removes native arrow */
  -webkit-appearance: none;
  -moz-appearance: none;
  position: relative;
  background-color: #fff;
  border: 2px solid #f0b0bd;
  color: #333;
  font-weight: 500;
  padding: 10px 40px 10px 18px; /* add space for custom arrow */
  border-radius: 25px;
  cursor: pointer;
    -position: right 12px center,
    -webkit-calc(100% - 20px) center;
}

#filterSelect:hover,
#filterSelect:focus {
  border-color: #e91e63;
  box-shadow: 0 0 0 0.15rem rgba(233, 30, 99, 0.25);
}

/* ðŸŒ· Fix Dropdown Alignment and Spacing */
#filterSelect {
  vertical-align: middle; /* keep aligned with text/button */
  display: inline-block;
  max-width: 180px; /* neat size */
  margin-left: 10px;
}

/* ðŸ©· Better layout on smaller screens */
@media (max-width: 768px) {
  .col-md-4.text-md-end {
    text-align: left !important;
    margin-top: 10px;
  }

  #filterSelect {
    width: 100%;
    margin-top: 10px;
    margin-left: 0;
  }
}

/* Optional: add spacing between button and dropdown */
.col-md-4.text-md-end > * {
  margin-bottom: 8px;
}

/* ðŸŒ¼ Badges */
.badge {
  border-radius: 10px;
  font-weight: 500;
  padding: 6px 10px;
}

.badge.bg-success {
  background-color: #a8e6cf !important;
  color: #155724;
}

.badge.bg-warning {
  background-color: #ffe8a1 !important;
  color: #856404;
}

.badge.bg-primary {
  background-color: #9ed0ff !important;
  color: #084298;
}

/* ðŸŒ¸ Buttons (small ones inside cards) */
.expense-card .btn-sm {
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 0.85rem;
  transition: all 0.2s ease;
}

.expense-card .btn-sm:hover {
  transform: scale(1.05);
}

/* ðŸŒ¼ Delete, Settle, and Pay buttons */
.btn-danger {
  background-color: #ff6b81 !important;
  border: none;
}

.btn-outline-success {
  border-color: #28a745 !important;
  color: #28a745 !important;
}

.btn-outline-success:hover {
  background-color: #28a745 !important;
  color: #fff !important;
}

/* ðŸŒ¸ Empty State Alert */
.alert-info {
  background-color: #ffeef3;
  border: 1px solid #f8c2d1;
  color: #d63384;
  border-radius: 15px;
  font-weight: 500;
}

/* ðŸŒ¸ Logout Modal */
.logout-modal {
  border-radius: 20px;
  background: #fffafc;
}

.logout-title {
  color: #e91e63;
}

.cancel-btn {
  background-color: #f8d7da;
  border: none;
  color: #b02a37;
  border-radius: 20px;
  padding: 8px 18px;
  transition: all 0.3s ease;
}

.cancel-btn:hover {
  background-color: #f5c2c7;
}

.confirm-logout-btn {
  background: linear-gradient(135deg, #ff8ba7, #e91e63);
  color: #fff;
  border: none;
  border-radius: 20px;
  padding: 8px 18px;
  transition: all 0.3s ease;
}

.confirm-logout-btn:hover {
  background: linear-gradient(135deg, #ff5f85, #d81b60);
  transform: translateY(-2px);
}

/* ðŸŒ¸ Smooth Animations */
.card, .btn, #filterSelect, .badge {
  transition: all 0.3s ease-in-out;
}

/* ðŸŒ· Responsive */
@media (max-width: 768px) {
  .btn-gradient {
    width: 100%;
  }

  #filterSelect {
    width: 100%;
    margin-top: 10px;
  }

  .expense-card {
    margin-bottom: 1.5rem;
  }
}

  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- ðŸŒ¸ Navbar -->
  <%- include('./partials/navbar', { activePage: 'groups', userId: userId }) %>

  <!-- ðŸŒ¸ Expenses Section -->
  <div class="container my-5">
    <div class="row mb-4 align-items-center">
      <div class="col-md-8">
        <h2>My Expenses</h2>
        <p class="text-muted">A list of all expenses you're involved in.</p>
      </div>
      <div class="col-md-4 text-md-end">
        <a href="/expenses/new" class="btn btn-gradient mb-2">+ Add New Expense</a>
        <select id="filterSelect" class="form-select w-auto d-inline-block">
          <option value="all" selected>Show All</option>
          <option value="pending">Pending</option>
          <option value="paid">Paid</option>
          <option value="settled">Settled</option>
        </select>
      </div>
    </div>

    <% if (!expenses || expenses.length === 0) { %>
      <div class="alert alert-info text-center">
        No expenses yet. Add one to get started! ðŸŒ¸
      </div>
    <% } else { %>

      <% expenses.forEach(expense => {
        const meKey = String(userId);
        const participantsArr = (expense.participants && expense.participants.length)
          ? expense.participants.map(p => String(p))
          : ((expense.group && expense.group.members)
            ? expense.group.members.map(m => String(m._id))
            : []);
        const isPayer = expense.paidBy && (String(expense.paidBy._id || expense.paidBy) === meKey);
        const payeeName = expense.paidBy?.username || expense.paidBy?.name || "Unknown";
        const splitAmount = (expense.amount / (participantsArr.length || 1));
        const mePaid = expense.paidSplits && expense.paidSplits[meKey];
        const allPaid = Object.values(expense.paidSplits || {}).every(Boolean);
        const status = allPaid ? "settled" : (mePaid ? "paid" : "pending");
      %>

      <div class="card mb-4 shadow-sm expense-card" data-status="<%= status %>">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="card-title mb-1"><%= expense.description || "Untitled Expense" %></h5>
              <small class="text-muted">
                Group: <strong><%= expense.group?.name || 'â€”' %></strong> |
                Paid by <strong><%= payeeName %></strong> |
                <%= new Date(expense.date).toLocaleDateString() %>
              </small>
              <div class="mt-2 small text-muted">
                ðŸ’° Total: â‚¹<%= expense.amount %> |
                Your Share: â‚¹<%= splitAmount.toFixed(2) %>
              </div>

              <div class="mt-2">
                <small class="text-muted">Participants:</small>
                <ul class="list-unstyled small mb-0">
                  <% participantsArr.forEach(pid => {
                    const pidStr = String(pid);
                    const member = (expense.group?.members)
                      ? expense.group.members.find(m => String(m._id) === pidStr)
                      : null;
                    const displayName = member?.username || member?.name || member?.email || pidStr;
                    const paidFlag = expense.paidSplits && expense.paidSplits[pidStr];
                  %>
                    <li>
                      <strong><%= displayName %></strong>
                      <% if (paidFlag) { %>
                        <span class="badge bg-success ms-2">Paid</span>
                      <% } else { %>
                        <span class="badge bg-warning text-dark ms-2">Pending</span>
                      <% } %>
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>

            <!-- ðŸŒ¸ Status Badge -->
            <div class="text-end">
              <% if (status === "settled") { %>
                <span class="badge bg-success">Settled</span>
              <% } else if (status === "paid") { %>
                <span class="badge bg-primary">Paid</span>
              <% } else { %>
                <span class="badge bg-warning text-dark">Pending</span>
              <% } %>
            </div>
          </div>

          <!-- ðŸŒ¸ Buttons -->
          <div class="mt-3 d-flex flex-wrap gap-2">
            <% if (!mePaid && !isPayer) { %>
              <button
                class="btn btn-sm btn-primary pay-btn"
                data-expense-id="<%= expense._id %>"
                data-amount="<%= splitAmount.toFixed(2) %>"
                data-payee-name="<%= payeeName %>">
                Pay â‚¹<%= splitAmount.toFixed(2) %>
              </button>
            <% } %>

            <form action="/expenses/<%= expense._id %>/pay" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-success">âœ… Mark as Paid</button>
            </form>

            <% if (isPayer) { %>
              <form action="/expenses/<%= expense._id %>/delete" method="POST" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-danger">ðŸ—‘ Delete</button>
              </form>

              <form action="/expenses/<%= expense._id %>/settle" method="POST" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-outline-success">âœ” Mark as Settled</button>
              </form>
            <% } %>
          </div>
        </div>
      </div>

      <% }) %>
    <% } %>
  </div>

  <!-- ðŸŒ¸ Logout Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content logout-modal text-center shadow-lg">
        <div class="modal-header border-0 justify-content-center">
          <h5 class="modal-title fw-bold fs-4 logout-title" id="logoutModalLabel">
            Are you sure you want to logout?
          </h5>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-4">Youâ€™ll be signed out from Smart Expense Splitter ðŸ’—</p>
          <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn confirm-logout-btn" onclick="logoutUser()">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('./partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const razorpayKeyId = '<%= razorpayKeyId %>';

    // ðŸ’¸ Razorpay Payment Flow
    document.addEventListener('click', async function (e) {
      const btn = e.target.closest('.pay-btn');
      if (!btn) return;

      const expenseId = btn.dataset.expenseId;
      const amount = Number(btn.dataset.amount);
      if (!expenseId || !amount) return alert('Invalid payment amount.');

      const resp = await fetch('/create-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ expenseId, amount })
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ message: 'Server error' }));
        return alert(err.message || 'Could not create order.');
      }

      const order = await resp.json();

      const options = {
        key: razorpayKeyId,
        amount: order.amount,
        currency: order.currency,
        name: "Smart Expense Splitter",
        description: `Pay split for expense ${expenseId}`,
        order_id: order.id,
        handler: async function (paymentResponse) {
          const verifyResp = await fetch('/verify-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              razorpay_order_id: paymentResponse.razorpay_order_id,
              razorpay_payment_id: paymentResponse.razorpay_payment_id,
              razorpay_signature: paymentResponse.razorpay_signature,
              expenseId
            })
          });
          const data = await verifyResp.json();
          if (data.status === 'success') {
            alert('Payment successful âœ…');
            location.reload();
          } else {
            alert('Payment verification failed âŒ');
          }
        },
        theme: { color: "#F0B0BD" }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    });

    // ðŸŒˆ Filter logic
    const filterSelect = document.getElementById('filterSelect');
    const cards = document.querySelectorAll('.expense-card');

    filterSelect.addEventListener('change', () => {
      const selected = filterSelect.value;
      cards.forEach(card => {
        const status = card.getAttribute('data-status');
        card.style.display = (selected === 'all' || status === selected) ? 'block' : 'none';
      });
    });

    function logoutUser() {
      document.getElementById("logoutForm")?.submit();
    }
  </script>
</body>
</html>

